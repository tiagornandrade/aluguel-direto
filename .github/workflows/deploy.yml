name: CD (Deploy to Cloud Run)

on:
  push:
    branches: [main]

env:
  GCP_PROJECT_ID: intendra-deployments
  GCP_REGION: us-central1
  BACKEND_SERVICE: aluguel-direto-api
  FRONTEND_SERVICE: aluguel-direto

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy Backend to Cloud Run
        run: make deploy-backend
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
          BACKEND_SERVICE: ${{ env.BACKEND_SERVICE }}

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy Frontend to Cloud Run
        run: make deploy-frontend
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
          FRONTEND_SERVICE: ${{ env.FRONTEND_SERVICE }}
